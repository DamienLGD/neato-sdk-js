/**
 *  Neato SDK Javascript
 *  https://github.com/NeatoRobotics/neato-sdk-js
 *
 *  Copyright (c)2016 Neato Robotics, Inc.
 *  Author: Roberto Ostinelli
 *
 *  Version: 0.7.0
 */
var Neato={};Neato.utils={haveEqualProps:function(e,t){var n;for(n in e)if("undefined"==typeof t[n])return!1;for(n in e)if(e[n])switch(typeof e[n]){case"object":if(!this.haveEqualProps(e[n],t[n]))return!1;break;case"function":if("undefined"==typeof t[n]||"equals"!=n&&e[n].toString()!=t[n].toString())return!1;break;default:if(e[n]!=t[n])return!1}else if(t[n])return!1;for(n in t)if("undefined"==typeof e[n])return!1;return!0},clone:function(e,t){t=t||{};var n={},o=t.except,r=t.only;for(var i in e)!e.hasOwnProperty(i)||-1!==$.inArray(i,o)||"undefined"!=typeof r&&-1===$.inArray(i,r)||(n[i]=e[i]);return n},isNullOrEmptyJSON:function(e){return null==e?!0:jQuery.isEmptyObject(e)?!0:!1}},Neato.User=function(){this.initialize.apply(this,arguments)},Neato.User.prototype={initialize:function(){this.__parseRedirectURIResponse(),this.host="beehive.neatocloud.com",this.oauthHost="apps.neatorobotics.com",this.robots=[]},getUserInfo:function(){return this.__call("GET","/users/me")},getRobots:function(){var e=this,t=$.Deferred();return this.__call("GET","/users/me/robots").done(function(n){e.robots=[];for(var o=0;o<n.length;o++)e.robots.push(new Neato.Robot(n[o].serial,n[o].secret_key,{name:n[o].name,model:n[o].model}));t.resolve.call(e,e.robots)}).fail(function(n){t.reject.call(e,n)}),t},getRobotBySerial:function(e){for(var t=0;t<this.robots.length;t++)if(0==this.robots[t].serial.localeCompare(e))return this.robots[t];return null},login:function(e){e=e||{};var t="https://"+this.oauthHost+"/oauth2/authorize?client_id="+e.clientId+"&scope="+e.scopes+"&response_type=token&redirect_uri="+e.redirectUrl;this.__navigateToURL(t)},logout:function(){var e=this;return this.__call("POST","/oauth2/revoke",{token:e.token})},isConnected:function(){var e=this,t=$.Deferred();return this.__sessionsCheck().done(function(n){e.connected=!0,t.resolve.call(e,!0)}).fail(function(n){e.connected=!1,t.reject.call(e,!1)}),t},authenticationError:function(){return void 0!=this.authError},__sessionsCheck:function(){return this.__call("GET","/users/me")},__navigateToURL:function(e){location.replace(e)},__parseRedirectURIResponse:function(){var e=document.location.hash.replace("#","").split("&"),t=this;e.forEach(function(e,n){var o=e.split("=")[0]||"",r=e.split("=")[1]||"";0==o.localeCompare("access_token")?t.token=r:0==o.localeCompare("error")?t.authError=r:0==o.localeCompare("error_description")&&(t.authErrorDescription=r.replace(/\+/g," "))})},__call:function(e,t,n){n=0==e.localeCompare("GET")?n||null:n||{};var o=this,r=$.Deferred(),i="https://"+this.host+t,a="application/vnd.neato.beehive.v1+json",s=new Date,c=s.toUTCString(),l=null==n?null:JSON.stringify(n),u="Bearer "+this.token,d=$.ajax({crossDomain:!0,dataType:"json",method:e,url:i,headers:{Accept:a,Authorization:u,"X-Date":c,"Content-type":"application/json"},data:l});return d.done(function(e,t,n){r.resolve.call(o,n.responseJSON)}).fail(function(e,t,n){r.reject.call(o,e.responseJSON)}),r}},Neato.Robot=function(){this.initialize.apply(this,arguments)},Neato.Robot.prototype={initialize:function(e,t,n){this.serial=e,this.secretKey=t,n=n||{},this.host="nucleo.neatocloud.com",this.port=4443,this.onConnected=n.onConnected,this.onDisconnected=n.onDisconnected,this.onStateChange=n.onStateChange,this.name=n.name,this.model=n.model},connect:function(){var e=this;this.timer=setInterval(function(){e.getState.apply(e)},3e3),this.getState()},disconnect:function(){clearInterval(this.timer),delete this.timer,this.__disconnect()},getState:function(){var e={reqId:"1",cmd:"getRobotState"};return this.__call(e)},getInfo:function(){var e={reqId:"1",cmd:"getRobotInfo"};return this.__call(e)},__call:function(e){var t=this,n=$.Deferred(),o="https://"+this.host+":"+this.port+"/vendors/neato/robots/"+this.serial+"/messages",r="application/vnd.neato.nucleo.v1",i=new Date,a=i.toUTCString(),s=JSON.stringify(e),c=this.serial.toLowerCase()+"\n"+a+"\n"+s,l="NEATOAPP "+CryptoJS.HmacSHA256(c,this.secretKey);return $.ajax({crossDomain:!0,dataType:"json",method:"POST",url:o,headers:{Accept:r,Authorization:l,"X-Date":a},data:s}).done(function(e,o,r){var i=r.responseJSON;t.__setState(i);var a=t.__extractReplyFromReponse(i);"ok"==a.result?n.resolve.call(t,a.result,a.data):n.reject.call(t,a.result,a.data)}).fail(function(e,n,o){t.__disconnect(e.status,e.responseJSON)}),n},__setState:function(e){if("undefined"!=typeof e.state){var t=Neato.utils.clone(e,{except:["version","reqId","result","data"]}),n="undefined"==typeof this.state,o=n||!Neato.utils.haveEqualProps(this.state,t);this.state=t,n&&this.onConnected&&this.onConnected(),o&&this.onStateChange&&this.onStateChange()}},__disconnect:function(e,t){delete this.state,this.onDisconnected&&this.onDisconnected(e,t)},__extractReplyFromReponse:function(e){return Neato.utils.clone(e,{only:["result","data"]})}},Neato.Robot.extend=function(e){for(var t in e)e.hasOwnProperty(t)&&(Neato.Robot.prototype[t]=e[t])},Neato.Robot.extend({findMe:function(){var e={reqId:"1",cmd:"findMe"};return this.__call(e)}}),Neato.Robot.extend({generalInfo:function(){var e={reqId:"1",cmd:"getGeneralInfo"};return this.__call(e)}}),Neato.Robot.extend({startCleaning:function(e){e=e||{};var t={reqId:"1",cmd:"startCleaning",params:{category:e.category,mode:e.mode,modifier:e.modifier,navigationMode:e.navigationMode}};return this.__call(t)},stopCleaning:function(){var e={reqId:"1",cmd:"stopCleaning"};return this.__call(e)},pauseCleaning:function(){var e={reqId:"1",cmd:"pauseCleaning"};return this.__call(e)},resumeCleaning:function(){var e={reqId:"1",cmd:"resumeCleaning"};return this.__call(e)},sendToBase:function(){var e={reqId:"1",cmd:"sendToBase"};return this.__call(e)}}),Neato.Robot.extend({setSchedule:function(e){e=e||{};var t=$.map(e,function(e,t){return{mode:e.mode,day:parseInt(t,10),startTime:e.startTime}}),n={reqId:"1",cmd:"setSchedule",params:{type:1,events:t}};return this.__call(n)},getSchedule:function(){var e={reqId:"1",cmd:"getSchedule"};return this.__call(e)},enableSchedule:function(){var e={reqId:"1",cmd:"enableSchedule"};return this.__call(e)},disableSchedule:function(){var e={reqId:"1",cmd:"disableSchedule"};return this.__call(e)}});
