/**
 *  Neato SDK Javascript
 *  https://github.com/NeatoRobotics/neato-sdk-js
 *
 *  Copyright (c)2016 Neato Robotics, Inc.
 *  Author: Roberto Ostinelli
 *
 *  Version: 0.1.0
 */
var Neato=function(){this.initialize.apply(this,arguments)};Neato.prototype={initialize:function(e){e=e||{},this.nucleo=new Nucleo({onConnected:e.onConnected,onDisconnected:e.onDisconnected,onStateChange:e.onStateChange})},connectTo:function(e,t){this.nucleo.connectTo(e,t)},disconnectFrom:function(e){this.nucleo.disconnectFrom(e)},getRobotState:function(e,t){this.nucleo.getRobotState(e,t)},getRobotInfo:function(e,t){this.nucleo.getRobotInfo(e,t)},startCleaning:function(e,t,n){this.nucleo.startCleaning(e,t,n)},stopCleaning:function(e,t){this.nucleo.stopCleaning(e,t)},pauseCleaning:function(e,t){this.nucleo.pauseCleaning(e,t)},resumeCleaning:function(e,t){this.nucleo.resumeCleaning(e,t)},sendToBase:function(e,t){this.nucleo.sendToBase(e,t)},setSchedule:function(e,t,n){this.nucleo.setSchedule(e,t,n)},getSchedule:function(e,t){this.nucleo.getSchedule(e,t)},enableSchedule:function(e,t){this.nucleo.enableSchedule(e,t)},disableSchedule:function(e,t){this.nucleo.disableSchedule(e,t)}},Neato.utils={haveEqualProps:function(e,t){var n;for(n in e)if("undefined"==typeof t[n])return!1;for(n in e)if(e[n])switch(typeof e[n]){case"object":if(!this.haveEqualProps(e[n],t[n]))return!1;break;case"function":if("undefined"==typeof t[n]||"equals"!=n&&e[n].toString()!=t[n].toString())return!1;break;default:if(e[n]!=t[n])return!1}else if(t[n])return!1;for(n in t)if("undefined"==typeof e[n])return!1;return!0},clone:function(e,t){t=t||{};var n={},o=t.except,i=t.only;for(var a in e)!e.hasOwnProperty(a)||-1!==$.inArray(a,o)||"undefined"!=typeof i&&-1===$.inArray(a,i)||(n[a]=e[a]);return n}},Neato.Robot=function(){this.initialize.apply(this,arguments)},Neato.Robot.prototype={initialize:function(e,t,n){this.serial=e,this.secretKey=t,n=n||{},this.host="nucleo.neatocloud.com",this.port=4443,this.onConnected=n.onConnected,this.onDisconnected=n.onDisconnected,this.onStateChange=n.onStateChange},connect:function(){var e=this;this.timer=setInterval(function(){e.getState.apply(e)},3e3),this.getState()},disconnect:function(){clearInterval(this.timer),delete this.timer,this.__disconnect()},getState:function(){var e={reqId:"1",cmd:"getRobotState"};return this.__call(e)},getInfo:function(){var e={reqId:"1",cmd:"getRobotInfo"};return this.__call(e)},__call:function(e){var t=this,n=$.Deferred(),o="https://"+this.host+":"+this.port+"/vendors/neato/robots/"+this.serial+"/messages",i="application/vnd.neato.nucleo.v1",a=new Date,s=a.toUTCString(),c=JSON.stringify(e),r=this.serial.toLowerCase()+"\n"+s+"\n"+c,u="NEATOAPP "+CryptoJS.HmacSHA256(r,this.secretKey);return $.ajax({crossDomain:!0,dataType:"json",method:"POST",url:o,headers:{Accept:i,Authorization:u,"X-Date":s},data:c}).done(function(e,o,i){var a=i.responseJSON;t.__setState(a);var s=t.__extractReplyFromReponse(a);"ok"==s.result?n.resolve.call(t,s.result,s.data):n.reject.call(t,s.result,s.data)}).fail(function(e,n,o){t.__disconnect(e.status,e.responseJSON)}),n},__setState:function(e){if("undefined"!=typeof e.state){var t=Neato.utils.clone(e,{except:["version","reqId","result","data"]}),n="undefined"==typeof this.state,o="undefined"==typeof this.state||!Neato.utils.haveEqualProps(this.state,t);this.state=t,n&&this.onConnected&&this.onConnected(),o&&this.onStateChange&&this.onStateChange()}},__disconnect:function(e,t){delete this.state,this.onDisconnected&&this.onDisconnected(e,t)},__extractReplyFromReponse:function(e){return Neato.utils.clone(e,{only:["result","data"]})}},Neato.Robot.extend=function(e){for(var t in e)e.hasOwnProperty(t)&&(Neato.Robot.prototype[t]=e[t])},Neato.Robot.extend({startCleaning:function(e){e=e||{};var t={reqId:"1",cmd:"startCleaning",params:{category:e.category,mode:e.mode,modifier:e.modifier}};return this.__call(t)},stopCleaning:function(){var e={reqId:"1",cmd:"stopCleaning"};return this.__call(e)},pauseCleaning:function(){var e={reqId:"1",cmd:"pauseCleaning"};return this.__call(e)},resumeCleaning:function(){var e={reqId:"1",cmd:"resumeCleaning"};return this.__call(e)},sendToBase:function(){var e={reqId:"1",cmd:"sendToBase"};return this.__call(e)}}),Neato.Robot.extend({setSchedule:function(e){e=e||{};var t=$.map(e,function(e,t){return{mode:e.mode,day:parseInt(t,10),startTime:e.startTime}}),n={reqId:"1",cmd:"setSchedule",params:{type:1,events:t}};return this.__call(n)},getSchedule:function(){var e={reqId:"1",cmd:"getSchedule"};return this.__call(e)},enableSchedule:function(){var e={reqId:"1",cmd:"enableSchedule"};return this.__call(e)},disableSchedule:function(){var e={reqId:"1",cmd:"disableSchedule"};return this.__call(e)}});
